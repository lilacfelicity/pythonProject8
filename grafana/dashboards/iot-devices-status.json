{
  "dashboard": {
    "id": null,
    "uid": "iot-devices-status",
    "title": "IoT Devices Status Dashboard",
    "description": "Статус и активность IoT устройств",
    "tags": ["iot", "devices", "status"],
    "timezone": "browser",
    "editable": true,
    "graphTooltip": 1,
    "panels": [
      {
        "id": 3,
        "title": "Активные устройства",
        "type": "stat",
        "datasource": {
          "type": "postgres",
          "uid": "postgres"
        },
        "targets": [
          {
            "datasource": {
              "type": "postgres",
              "uid": "postgres"
            },
            "rawSql": "SELECT COUNT(DISTINCT d.id) as \"Активные устройства\" FROM devices d WHERE d.status = 'active' AND d.last_seen >= NOW() - INTERVAL '5 minutes'",
            "refId": "A",
            "format": "table"
          }
        ],
        "fieldConfig": {
          "defaults": {
            "color": {
              "mode": "thresholds"
            },
            "thresholds": {
              "steps": [
                { "color": "red", "value": null },
                { "color": "yellow", "value": 1 },
                { "color": "green", "value": 3 }
              ]
            },
            "unit": "short"
          }
        },
        "gridPos": {
          "h": 4,
          "w": 6,
          "x": 0,
          "y": 0
        }
      },
      {
        "id": 4,
        "title": "Устройства в сети",
        "type": "stat",
        "datasource": {
          "type": "postgres",
          "uid": "postgres"
        },
        "targets": [
          {
            "datasource": {
              "type": "postgres",
              "uid": "postgres"
            },
            "rawSql": "SELECT COUNT(*) as \"Онлайн устройства\" FROM devices d WHERE d.last_seen >= NOW() - INTERVAL '1 minute'",
            "refId": "B",
            "format": "table"
          }
        ],
        "fieldConfig": {
          "defaults": {
            "color": {
              "mode": "thresholds"
            },
            "thresholds": {
              "steps": [
                { "color": "red", "value": null },
                { "color": "yellow", "value": 1 },
                { "color": "green", "value": 2 }
              ]
            },
            "unit": "short"
          }
        },
        "gridPos": {
          "h": 4,
          "w": 6,
          "x": 6,
          "y": 0
        }
      },
      {
        "id": 5,
        "title": "Средняя задержка",
        "type": "stat",
        "datasource": {
          "type": "postgres",
          "uid": "postgres"
        },
        "targets": [
          {
            "datasource": {
              "type": "postgres",
              "uid": "postgres"
            },
            "rawSql": "SELECT AVG(EXTRACT(EPOCH FROM (NOW() - d.last_seen))) as \"Задержка сек\" FROM devices d WHERE d.status = 'active'",
            "refId": "C",
            "format": "table"
          }
        ],
        "fieldConfig": {
          "defaults": {
            "color": {
              "mode": "thresholds"
            },
            "thresholds": {
              "steps": [
                { "color": "green", "value": null },
                { "color": "yellow", "value": 60 },
                { "color": "red", "value": 300 }
              ]
            },
            "unit": "s",
            "decimals": 0
          }
        },
        "gridPos": {
          "h": 4,
          "w": 6,
          "x": 12,
          "y": 0
        }
      },
      {
        "id": 6,
        "title": "Неактивные устройства",
        "type": "stat",
        "datasource": {
          "type": "postgres",
          "uid": "postgres"
        },
        "targets": [
          {
            "datasource": {
              "type": "postgres",
              "uid": "postgres"
            },
            "rawSql": "SELECT COUNT(*) as \"Неактивные устройства\" FROM devices d WHERE d.last_seen < NOW() - INTERVAL '5 minutes' OR d.status = 'inactive'",
            "refId": "D",
            "format": "table"
          }
        ],
        "fieldConfig": {
          "defaults": {
            "color": {
              "mode": "thresholds"
            },
            "thresholds": {
              "steps": [
                { "color": "green", "value": null },
                { "color": "yellow", "value": 1 },
                { "color": "red", "value": 2 }
              ]
            },
            "unit": "short"
          }
        },
        "gridPos": {
          "h": 4,
          "w": 6,
          "x": 18,
          "y": 0
        }
      },
      {
        "id": 9,
        "title": "Распределение по статусу",
        "type": "piechart",
        "datasource": {
          "type": "postgres",
          "uid": "postgres"
        },
        "targets": [
          {
            "datasource": {
              "type": "postgres",
              "uid": "postgres"
            },
            "rawSql": "SELECT \n  CASE \n    WHEN d.last_seen >= NOW() - INTERVAL '1 minute' THEN 'Онлайн'\n    WHEN d.last_seen >= NOW() - INTERVAL '5 minutes' THEN 'Недавно активные'\n    ELSE 'Оффлайн'\n  END as metric,\n  COUNT(*) as value\nFROM devices d \nGROUP BY \n  CASE \n    WHEN d.last_seen >= NOW() - INTERVAL '1 minute' THEN 'Онлайн'\n    WHEN d.last_seen >= NOW() - INTERVAL '5 minutes' THEN 'Недавно активные'\n    ELSE 'Оффлайн'\n  END",
            "refId": "B",
            "format": "table"
          }
        ],
        "fieldConfig": {
          "defaults": {
            "color": {
              "mode": "palette-classic"
            },
            "custom": {
              "hideFrom": {
                "tooltip": false,
                "vis": false,
                "legend": false
              }
            },
            "mappings": [
              {
                "type": "value",
                "value": "Онлайн",
                "text": "Онлайн",
                "color": "green"
              },
              {
                "type": "value",
                "value": "Недавно активные",
                "text": "Недавно активные",
                "color": "yellow"
              },
              {
                "type": "value",
                "value": "Оффлайн",
                "text": "Оффлайн",
                "color": "red"
              }
            ]
          }
        },
        "options": {
          "reduceOptions": {
            "values": false,
            "calcs": ["lastNotNull"],
            "fields": ""
          },
          "pieType": "pie",
          "tooltip": {
            "mode": "single",
            "sort": "none"
          },
          "legend": {
            "displayMode": "visible",
            "placement": "right",
            "values": ["value"]
          }
        },
        "gridPos": {
          "h": 8,
          "w": 12,
          "x": 0,
          "y": 4
        }
      },
      {
        "id": 10,
        "title": "Детали устройств",
        "type": "table",
        "datasource": {
          "type": "postgres",
          "uid": "postgres"
        },
        "targets": [
          {
            "datasource": {
              "type": "postgres",
              "uid": "postgres"
            },
            "rawSql": "SELECT \n  d.name as \"Устройство\",\n  d.device_id as \"ID\",\n  CONCAT(up.first_name, ' ', up.last_name) as \"Пациент\",\n  d.status as \"Статус\",\n  d.last_seen as \"Последняя активность\",\n  CASE \n    WHEN d.last_seen >= NOW() - INTERVAL '1 minute' THEN 'Онлайн'\n    WHEN d.last_seen >= NOW() - INTERVAL '5 minutes' THEN 'Недавно'\n    ELSE 'Оффлайн'\n  END as \"Состояние\",\n  EXTRACT(EPOCH FROM (NOW() - d.last_seen))::integer as \"Задержка (сек)\"\nFROM devices d\nJOIN users u ON d.user_id = u.id\nJOIN user_profiles up ON u.id = up.user_id\nORDER BY d.last_seen DESC",
            "refId": "C",
            "format": "table"
          }
        ],
        "fieldConfig": {
          "defaults": {
            "custom": {
              "displayMode": "basic",
              "filterable": true,
              "align": "left"
            }
          },
          "overrides": [
            {
              "matcher": {
                "id": "byName",
                "options": "Состояние"
              },
              "properties": [
                {
                  "id": "custom.cellOptions",
                  "value": {
                    "type": "color-background",
                    "mode": "basic"
                  }
                },
                {
                  "id": "mappings",
                  "value": [
                    {
                      "type": "value",
                      "value": "Онлайн",
                      "text": "Онлайн",
                      "color": "green"
                    },
                    {
                      "type": "value",
                      "value": "Недавно",
                      "text": "Недавно",
                      "color": "yellow"
                    },
                    {
                      "type": "value",
                      "value": "Оффлайн",
                      "text": "Оффлайн",
                      "color": "red"
                    }
                  ]
                }
              ]
            },
            {
              "matcher": {
                "id": "byName",
                "options": "Задержка (сек)"
              },
              "properties": [
                {
                  "id": "unit",
                  "value": "s"
                },
                {
                  "id": "thresholds",
                  "value": {
                    "steps": [
                      { "color": "green", "value": null },
                      { "color": "yellow", "value": 60 },
                      { "color": "red", "value": 300 }
                    ]
                  }
                }
              ]
            }
          ]
        },
        "gridPos": {
          "h": 8,
          "w": 12,
          "x": 12,
          "y": 4
        }
      },
      {
        "id": 11,
        "title": "Активность устройств во времени",
        "type": "timeseries",
        "datasource": {
          "type": "postgres",
          "uid": "postgres"
        },
        "targets": [
          {
            "datasource": {
              "type": "postgres",
              "uid": "postgres"
            },
            "rawSql": "SELECT \n  DATE_TRUNC('minute', hd.timestamp) as time,\n  COUNT(DISTINCT hd.device_id) as \"Кардиологические устройства\"\nFROM heart_data hd\nJOIN devices d ON hd.device_id = d.id\nWHERE $__timeFilter(hd.timestamp)\nGROUP BY DATE_TRUNC('minute', hd.timestamp)\nORDER BY time",
            "refId": "A",
            "format": "time_series"
          },
          {
            "datasource": {
              "type": "postgres",
              "uid": "postgres"
            },
            "rawSql": "SELECT \n  DATE_TRUNC('minute', sr.timestamp) as time,\n  COUNT(DISTINCT sr.device_id) as \"Датчики окружающей среды\"\nFROM sensor_readings sr\nJOIN devices d ON sr.device_id = d.id\nWHERE $__timeFilter(sr.timestamp)\nGROUP BY DATE_TRUNC('minute', sr.timestamp)\nORDER BY time",
            "refId": "B",
            "format": "time_series"
          }
        ],
        "fieldConfig": {
          "defaults": {
            "color": {
              "mode": "palette-classic"
            },
            "custom": {
              "drawStyle": "line",
              "lineInterpolation": "smooth",
              "fillOpacity": 10,
              "pointSize": 3,
              "showPoints": "auto",
              "spanNulls": false,
              "stacking": {
                "group": "A",
                "mode": "none"
              }
            },
            "unit": "short",
            "min": 0
          }
        },
        "options": {
          "tooltip": {
            "mode": "multi",
            "sort": "none"
          },
          "legend": {
            "calcs": [],
            "displayMode": "visible",
            "placement": "bottom"
          }
        },
        "gridPos": {
          "h": 6,
          "w": 12,
          "x": 0,
          "y": 12
        }
      },
      {
        "id": 12,
        "title": "Загрузка сети (сообщений в минуту)",
        "type": "timeseries",
        "datasource": {
          "type": "postgres",
          "uid": "postgres"
        },
        "targets": [
          {
            "datasource": {
              "type": "postgres",
              "uid": "postgres"
            },
            "rawSql": "SELECT \n  DATE_TRUNC('minute', timestamp) as time,\n  COUNT(*) as \"Сообщений в минуту\"\nFROM (\n  SELECT timestamp FROM heart_data WHERE $__timeFilter(timestamp)\n  UNION ALL\n  SELECT timestamp FROM sensor_readings WHERE $__timeFilter(timestamp)\n) combined\nGROUP BY DATE_TRUNC('minute', timestamp)\nORDER BY time",
            "refId": "A",
            "format": "time_series"
          }
        ],
        "fieldConfig": {
          "defaults": {
            "color": {
              "mode": "continuous-GrYlRd"
            },
            "custom": {
              "drawStyle": "bars",
              "fillOpacity": 80,
              "gradientMode": "opacity",
              "pointSize": 5
            },
            "unit": "short",
            "min": 0
          }
        },
        "gridPos": {
          "h": 6,
          "w": 12,
          "x": 12,
          "y": 12
        }
      },
      {
        "id": 13,
        "title": "Типы устройств по пациентам",
        "type": "table",
        "datasource": {
          "type": "postgres",
          "uid": "postgres"
        },
        "targets": [
          {
            "datasource": {
              "type": "postgres",
              "uid": "postgres"
            },
            "rawSql": "SELECT \n  CONCAT(up.first_name, ' ', up.last_name) as \"Пациент\",\n  COUNT(d.id) as \"Всего устройств\",\n  COUNT(CASE WHEN d.name LIKE '%пульсометр%' OR d.name LIKE '%Пульсометр%' THEN 1 END) as \"Пульсометры\",\n  COUNT(CASE WHEN d.name LIKE '%тонометр%' OR d.name LIKE '%Тонометр%' THEN 1 END) as \"Тонометры\",\n  COUNT(CASE WHEN d.name LIKE '%датчик%' OR d.name LIKE '%Датчик%' THEN 1 END) as \"Датчики среды\",\n  COUNT(CASE WHEN d.name LIKE '%глюкометр%' OR d.name LIKE '%Глюкометр%' THEN 1 END) as \"Глюкометры\",\n  COUNT(CASE WHEN d.status = 'active' THEN 1 END) as \"Активные\",\n  COUNT(CASE WHEN d.status = 'inactive' THEN 1 END) as \"Неактивные\"\nFROM users u\nJOIN user_profiles up ON u.id = up.user_id\nLEFT JOIN devices d ON u.id = d.user_id\nWHERE u.role = 'patient'\nGROUP BY u.id, up.first_name, up.last_name\nORDER BY up.first_name",
            "refId": "D",
            "format": "table"
          }
        ],
        "fieldConfig": {
          "defaults": {
            "custom": {
              "displayMode": "basic",
              "filterable": true,
              "align": "left"
            }
          },
          "overrides": [
            {
              "matcher": {
                "id": "byName",
                "options": "Активные"
              },
              "properties": [
                {
                  "id": "custom.cellOptions",
                  "value": {
                    "type": "color-background",
                    "mode": "basic"
                  }
                },
                {
                  "id": "thresholds",
                  "value": {
                    "steps": [
                      { "color": "red", "value": null },
                      { "color": "yellow", "value": 1 },
                      { "color": "green", "value": 2 }
                    ]
                  }
                }
              ]
            },
            {
              "matcher": {
                "id": "byName",
                "options": "Неактивные"
              },
              "properties": [
                {
                  "id": "custom.cellOptions",
                  "value": {
                    "type": "color-background",
                    "mode": "basic"
                  }
                },
                {
                  "id": "thresholds",
                  "value": {
                    "steps": [
                      { "color": "green", "value": null },
                      { "color": "yellow", "value": 1 },
                      { "color": "red", "value": 2 }
                    ]
                  }
                }
              ]
            }
          ]
        },
        "gridPos": {
          "h": 8,
          "w": 24,
          "x": 0,
          "y": 18
        }
      }
    ],
    "time": {
      "from": "now-1h",
      "to": "now"
    },
    "refresh": "30s",
    "schemaVersion": 39,
    "version": 1
  }
}